import gradio as gr

# ë¡œê·¸ì¸ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
logged_in = False
user_insurances = []  # íšŒì›ì´ ê°€ì…í•œ ë³´í—˜ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸

# ë¡œê·¸ì¸ ê²€ì¦ í•¨ìˆ˜ (ê°„ë‹¨íˆ ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë§Œìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬)
def verify_login(username, password):
    global logged_in, user_insurances
    if username and password:
        logged_in = True
        # ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì—ê²Œ ê°€ì…ëœ ë³´í—˜ìƒí’ˆ ì„¤ì • (ì˜ˆ: í•œí™” ë³´í—˜ì‚¬ ì—°ê³„)
        user_insurances = ["ì•”ë³´í—˜", "ë‡Œì§ˆí™˜ë³´í—˜", "ìë™ì°¨ë³´í—˜", "ìƒí•´ë³´í—˜"]
        return gr.update(visible=False), gr.update(visible=True)
    else:
        return gr.update(visible=True), gr.update(visible=False)

# ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
def logout():
    global logged_in, user_insurances
    logged_in = False
    user_insurances = []
    return gr.update(visible=True), gr.update(visible=False)

# ì±—ë´‡ ëŒ€í™” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
def update_chatbot_with_message(chat_history, sender, message):
    chat_history.append((sender, message))  # ì§€ì •ëœ ë°œì‹ ìì™€ ë©”ì‹œì§€ ì¶”ê°€
    return chat_history

# ì±„íŒ… ì œì¶œ ì‹œ ì‘ë‹µ ìƒì„± (ë”ë¯¸ ì˜ˆì œ í•¨ìˆ˜)
def submit(message, history):
    response_message = f"'{message}'ì— ëŒ€í•œ ë‹µë³€ì…ë‹ˆë‹¤."  # ì§ˆë¬¸ì— ëŒ€í•œ ë”ë¯¸ ë‹µë³€
    history.append((message, response_message))  # ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
    return history, ""

# ë³´í—˜ ë¬¸ì„œ ì„ íƒ ì‹œ ì±—ë´‡ ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì • í•¨ìˆ˜
def select_insurance(insurance_name, history):
    message = f"'{insurance_name}' ë¬¸ì„œì— ê´€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”."
    history.append(("ì‹œìŠ¤í…œ", message))
    return history

# Gradio UI
with gr.Blocks(css=".gr-block { background-color: white; }") as iface:
    # ì²« ë²ˆì§¸ í˜ì´ì§€ - ë¡œê·¸ì¸ ì—†ì´ ê¸°ë³¸ ë¬¸ë‹µ ê°€ëŠ¥
    with gr.Row(visible=not logged_in) as main_page:
        with gr.Column(scale=7):
            gr.Markdown("### ë³´í—˜ ë¬¸ì„œì— ê´€í•œ ë¬¸ë‹µ", elem_id="insurance-qna-title")
            public_chatbot = gr.Chatbot(type='messages')
            public_msg = gr.Textbox(placeholder="ë³´í—˜ ë¬¸ì„œì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”.", label="ì±— ì…ë ¥")
            public_submit_btn = gr.Button("ë³´ë‚´ê¸°")
            public_submit_btn.click(submit, [public_msg, public_chatbot], [public_chatbot, public_msg])
        
        with gr.Column(scale=3, elem_id="login-container", min_width=400):
            gr.Markdown("### ë¡œê·¸ì¸ í›„ ë§ì¶¤í˜• ìƒë‹´ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.", elem_id="login-info")
            gr.Markdown("### ë¡œê·¸ì¸", elem_id="login-title")
            username = gr.Textbox(label="ì•„ì´ë””", placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            password = gr.Textbox(label="ë¹„ë°€ë²ˆí˜¸", type="password", placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            login_btn = gr.Button("ë¡œê·¸ì¸")

    # ë‘ ë²ˆì§¸ í˜ì´ì§€ - ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ë³´í—˜ ë¬¸ì„œ ê´€ë ¨ ì±—ë´‡ ê¸°ëŠ¥
    with gr.Column(visible=logged_in) as chatbot_screen:
        gr.Markdown("### ì‚¬ìš©ìê°€ ê°€ì…í•œ ë³´í—˜ ë¬¸ì„œì— ê´€í•œ ì±—ë´‡", elem_id="user-insurance-chat-title")
        chatbot = gr.Chatbot(type='messages')
        with gr.Row():
            for insurance in ["ì•”ë³´í—˜", "ë‡Œì§ˆí™˜ë³´í—˜", "ìë™ì°¨ë³´í—˜", "ìƒí•´ë³´í—˜"]:
                gr.Button(insurance).click(
                    lambda ins=insurance: select_insurance(ins, chatbot.value),
                    inputs=[chatbot],
                    outputs=[chatbot]
                )
        msg = gr.Textbox(placeholder="ê°€ì…í•œ ë³´í—˜ ë¬¸ì„œì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”.", label="ì±— ì…ë ¥")

        # ë²„íŠ¼ í–‰
        with gr.Row():
            submit_btn = gr.Button("ë³´ë‚´ê¸°")
            retry_btn = gr.Button("ë‹¤ì‹œë³´ë‚´ê¸° â†©")
            undo_btn = gr.Button("ì´ì „ ì±„íŒ… ì‚­ì œ âŒ")
            clear_btn = gr.Button("ì „ì²´ ì±„íŒ… ì‚­ì œ ğŸ’«")
            logout_btn = gr.Button("ë¡œê·¸ì•„ì›ƒ")  # ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼

        # ë²„íŠ¼ ê¸°ëŠ¥ ì—°ê²°
        submit_btn.click(submit, [msg, chatbot], [chatbot, msg])  # ë©”ì‹œì§€ ì œì¶œ
        retry_btn.click(lambda history: history, [chatbot], chatbot)  # ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¬ì²˜ë¦¬
        undo_btn.click(lambda history: history[:-1] if history else history, [chatbot], chatbot)  # ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‚­ì œ
        clear_btn.click(lambda: [], None, chatbot)  # ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”
        logout_btn.click(logout, outputs=[main_page, chatbot_screen])

    # ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
    login_btn.click(
        verify_login,
        inputs=[username, password],
        outputs=[main_page, chatbot_screen]
    )

# CSS ì¶”ê°€ë¡œ UI êµ¬ì„±
iface.css = """
#login-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: auto;
    width: 100%;
    max-width: 400px;
    height: 100vh;
    text-align: center;
    padding: 20px;
}
#login-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: auto;
    width: 100%;
    max-width: 400px;
    height: 100vh;
    text-align: center;
    padding: 20px;
}

#login-title {
    font-size: 24px;
    margin-bottom: 20px;
}

#login-info {
    font-size: 18px;
    margin-top: 10px;
    margin-bottom: 20px;
}
#insurance-qna-title, #user-insurance-chat-title {
    font-size: 24px;
    margin-bottom: 20px;
}
"""

iface.launch()
